# 002: Web Interface Implementation Plan

## Document Information
- **Type**: Implementation Plan
- **Related ADR**: [001-web-interface-architecture.md](./001-web-interface-architecture.md)
- **Date**: 2025-09-09
- **Status**: Ready for Implementation

## Overview
This document provides detailed technical implementation steps for adding a web interface to the YNAB Transformer application, as decided in ADR-001. The implementation maintains backward compatibility with the existing console application while adding automatic format detection and a user-friendly web interface.

---

## **Phase 1: Backend Architecture Changes** âœ… **COMPLETED**

### **1.1 Transformer Interface Enhancement** âœ…
- Add `canHandle(string $filename): bool` method to `Transformer` interface âœ…
- Implement `canHandle()` in all transformer classes: âœ…
  - Use existing transformation logic to test file compatibility âœ…
  - Return `true` if file can be processed, `false` if errors occur âœ…
  - Handle exceptions gracefully during detection âœ…

### **1.2 Console Command Auto-Detection Enhancement** âœ…
- **Update `TransformCommand`** to support automatic format detection: âœ…
  - Make `--format` parameter optional (currently required) âœ…
  - When `--format` not provided: use `TransformerFactory::detectFormat()` for auto-detection âœ…
  - When `--format` provided: maintain existing behavior (backward compatibility) âœ…
  - Display detected format to user: `"Format 'fineco' detected, processing..."` âœ…
  
- **Enhanced error handling and messaging**: âœ…
  - "No supported format detected. Supported formats: fineco, revolut, nexi, popso, poste, telepass, isybank" âœ…
  - "Multiple formats detected. Please specify manually with --format=<format>" âœ…
  - Clear success messages showing detected vs. specified format âœ…
  
- **Usage examples**: âœ…
  ```bash
  # Auto-detection (new behavior)
  php bin/console app:transform input_file.xlsx
  
  # Manual format specification (existing behavior, unchanged)
  php bin/console app:transform input_file.xlsx --format=fineco
  ```

### **1.3 Service Layer Extraction** âœ…
- **Create `TransformationService`**: âœ…
  - Orchestrates the transformation process âœ…
  - Uses TransformerFactory for auto-detection âœ…
  - Coordinates with FileProcessingService âœ…
  
- **Create `FileProcessingService`**: âœ…
  - Handles temporary file storage for uploads âœ…
  - Generates CSV download responses âœ…
  - Manages file cleanup (immediate deletion after processing) âœ…
  
- **Create `TransformerFactory`** (already implemented in 1.1): âœ…
  - Implements auto-detection logic using `canHandle()` methods âœ…
  - Tests formats in popularity order: `['fineco', 'revolut', 'nexi', 'popso', 'poste', 'telepass', 'isybank']` âœ…
  - Ensures only one format matches (throws exception if multiple matches) âœ…
  - Provides hints when no format detected âœ…

### **1.4 Web Dependencies** âœ…
- Add Symfony HTTP components to `composer.json`: âœ…
  - `symfony/http-foundation` âœ…
  - `symfony/http-kernel` âœ…
  - Required routing and controller components âœ…

---

## **Phase 2: Web Controller Implementation** âœ… **COMPLETED**

### **2.1 Main Controller** âœ…
- **Create `TransformController`**: âœ…
  - `GET /`: Serves the main web interface (root of Symfony app) âœ…
  - `POST /transform`: Handles file upload and processing âœ…
  - `GET /health`: Returns simple JSON status for monitoring âœ…
  - Uses dependency injection for services âœ…
  - Implements comprehensive error handling âœ…

### **2.2 File Upload Handling** âœ…
- Accept multipart form uploads (1MB file size limit) âœ…
- Validate file types (Excel/CSV only) âœ…
- Store uploads temporarily on disk âœ…
- Process files using `TransformationService` âœ…
- Return direct file download response for CSV output âœ…
- Always delete uploaded files after processing (privacy) âœ…

### **2.3 Error Response System** âœ…
- Return JSON error responses for AJAX requests âœ…
- Generic user messages (detailed errors only in logs) âœ…
- Specific error types: âœ…
  - File format not recognized (with hints) âœ…
  - Multiple formats detected âœ…
  - Processing errors âœ…
  - Upload errors âœ…

---

## **Phase 3: Frontend Implementation** âœ… **COMPLETED**

### **3.1 Technology Stack** âœ…
- **JavaScript**: For all reactive functionality including file upload handling âœ…
- **Tailwind CSS**: For styling and components âœ… (Note: Used Tailwind instead of Bootstrap)

### **3.2 User Interface** âœ…
- Single page application at `/` (root of Symfony app) âœ…
- Large drag-and-drop zone as primary interface âœ…
- "Browse Files" button for mobile/tablet compatibility âœ…
- Visual feedback during processing (loading indicator) âœ…
- Error banner system below drop zone âœ…
- Success banner: "Thank you for using this service!" after file download âœ…
- Privacy policy link at bottom pointing to `./privacy.html` (static file) âœ…
- Responsive design for desktop/tablet/mobile âœ…
- Footer with creator attribution âœ…

### **3.3 File Upload Flow** âœ…
- Immediate processing on file drop/selection âœ…
- **Single upload prevention**: Disable drop zone and browse button while processing âœ…
- Client-side file validation (size/type) âœ…
- AJAX upload with progress indication âœ…
- Automatic download trigger on success âœ…
- "Thank you" banner appears after download, auto-hides after 3-4 seconds âœ…
- Error display for failures âœ…
- Re-enable interface after completion or error âœ…

---

## **Phase 4: Security & Abuse Prevention** ğŸ”„ **PARTIALLY COMPLETED**

### **4.1 Rate Limiting** âŒ **PENDING**
- Implement IP-based rate limiting: 5 files per 10 minutes
- IP whitelist system for testing (bypass rate limits completely)
- Store rate limit data in temporary files/cache

### **4.2 Input Validation** âœ… **COMPLETED**
- Server-side file type validation âœ…
- File size enforcement (1MB limit) âœ…
- Input sanitization for all user data âœ…
- Secure temporary file handling âœ…

### **4.3 Security Headers** âŒ **PENDING**
- Implement basic security headers
- CSRF protection for forms
- Secure file upload handling âœ…

---

## **Phase 5: Logging & Monitoring** âŒ **PENDING**

### **5.1 Comprehensive Logging**
- **Basic data**: Timestamp, IP, file size, success/failure, processing time
- **Additional details**: Original filename, detected format, transaction count, error details, user agent
- Store in log files (not database)

### **5.2 Log Management**
- **Log rotation**: Automatic cleanup of log files older than 30 days
- Prevent unlimited disk space usage from logs
- Configurable retention period
- Rotate logs to prevent disk space issues

### **5.3 Privacy Compliance**
- Log IP addresses as provided
- Never log transaction content/data
- Immediate file deletion after processing
- Clear temporary file cleanup

---

## **Phase 6: Configuration & Deployment**

### **6.1 Environment Configuration**
- Add web-specific configuration options
- File upload path configuration
- Rate limiting configuration
- Logging configuration

### **6.2 Routing Setup**
- Configure Symfony to work within subdirectory deployment (`/ynab-transformer/`)
- Root route (`/`) serves the main transform interface
- Proper base path configuration for subdirectory hosting
- Maintain existing console command functionality

### **6.3 Static Files**
- Create `public/privacy.html` with privacy policy covering:
  - No data storage policy
  - Temporary processing consent
  - Logging practices (no transaction content)
  - Liability limitation clauses
  - Contact information

---

## **Phase 7: Testing & Documentation**

### **7.1 Automated Testing**
- Unit tests for new services
- Integration tests for web endpoints
- File upload testing
- Error handling verification
- Health check endpoint testing

### **7.2 Manual Testing**
- Cross-browser compatibility testing
- Mobile/tablet usability testing
- Performance testing with various file sizes
- Security testing (rate limiting, file validation)

### **7.3 Developer Documentation**
- **Local development setup instructions**
- **Project structure explanation**
- **How to add new transformer formats**
- **Deployment guide for subdirectory hosting**
- **Environment configuration options**
- **Health monitoring setup**
- **Log management procedures**

---

## **Technical Requirements Summary**

### **Backend Requirements:**
- PHP 8.4+
- Existing Symfony console application structure
- File system write permissions for temporary files and logs
- Web server configuration for Symfony applications in subdirectories

### **Frontend Requirements:**
- Modern browser with JavaScript enabled
- File API support for drag-and-drop
- Bootstrap 5 compatible browsers

### **Hosting Requirements:**
- PHP 8.4+ with required extensions
- Write permissions for temporary files and logs
- Standard web hosting or VPS capabilities
- Subdirectory hosting configuration
- HTTPS recommended for production

---

## **Deployment Structure**
```
somedomain.com/
â”œâ”€â”€ (other content)
â””â”€â”€ ynab-transformer/          # Symfony application root
    â”œâ”€â”€ public/
    â”‚   â”œâ”€â”€ index.php          # Symfony entry point
    â”‚   â””â”€â”€ privacy.html       # Static privacy policy
    â”œâ”€â”€ src/
    â”œâ”€â”€ config/
    â””â”€â”€ ...                    # Rest of Symfony structure
```

---

## **Deliverables**
1. Enhanced Symfony application with web interface
2. Unchanged console functionality  
3. Comprehensive logging system with rotation
4. Security and rate limiting features
5. Mobile-responsive web interface with single-upload UX
6. Health monitoring endpoint
7. Static privacy policy page
8. Complete developer documentation
9. Subdirectory deployment configuration

---

**This plan maintains backward compatibility while adding robust web functionality with proper security, logging, monitoring, and user experience considerations optimized for subdirectory hosting.**